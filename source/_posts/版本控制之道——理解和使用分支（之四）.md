---
title : 版本控制之道——理解和使用分支（之四）
---

#### 第一节 什么叫分支

添加新功能，重构代码，修复bug，发布等几个事项都可以分别作为一个分支。

1. 分支重命名 git branch -m master mymaster (-m移动/重命名，原名称，新名称) 
2. git branch命令显示本地版本库中所有的本地分支名称。

```
$ git branch
* blog-src
  gh-pages
  master

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/OrangeSite (blog-src)
$ git branch -m master mymaster

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/OrangeSite (blog-src)
$ git branch
* blog-src
  gh-pages
  mymaster
```

3. 有些版本控制系统在创建分支时会将所有的文件复制到新目录中。Git可不这么做，他只把分支创建后的修改记录在这条分支上。这么说并不准确，实际上，Git的分支只记录和跟踪该分支末梢的那个提交。因为沿这个版本回溯，可以找到该分支完整的历史轨迹。

#### 第二节  创建新分支

1. 创建新分支命令 **git branch** +新分支名称； 这个命令只是创建新分支，并不切换到新分支。从当前所在的分支检出。

2. 切换分支命令 **git checkout +分支名**

3. **git checkout -b +新分支名 +从哪个分支检出** 这个命令可直接切换到新分支，并从最后一个参数所在的分支检出。

#### 第三节 合并分之间的修改

合并分为三种：直接合并、压缩合并、拣选合并

1. 直接合并：把两条分支上的历史轨迹合并，交汇到一起

​        新建分支，创建about.html文件，提交到本地版本库，切换到主分支，执行 **git merge +分支名称**的命令来进行最简单的合并。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (autoNew)
$ vi about.html

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (autoNew)
$ git add about.html
warning: LF will be replaced by CRLF in about.html.
The file will have its original line endings in your working directory

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (autoNew)
$ git commit -m "add about page"
[autoNew a30e0e4] add about page
 1 file changed, 1 insertion(+)
 create mode 100644 about.html
 
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (autoNew)
$ git checkout master
Switched to branch 'master'

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git merge autoNew
Updating 75bfa04..a30e0e4
Fast-forward
 about.html | 1 +
 1 file changed, 1 insertion(+)
 create mode 100644 about.html
```

2. 压合合并：将一条分支上的若干个提交条目压合成一个提交条目，提交到另一条分支的末梢。

新建分支，在分支上新添加一个文件，提交到本地，再修改一次文件，再提交。然后切换到主分支，用**git merge --squash +分支名字**命令来将新分支上的**全部提交压合**成当前分支上的一个提交。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git checkout -b contact master
Switched to a new branch 'contact'

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ vi contact.html

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ git add contact.html
warning: LF will be replaced by CRLF in contact.html.
The file will have its original line endings in your working directory

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ git commit -m "add contact file"
[contact 9005c8b] add contact file
 1 file changed, 1 insertion(+)
 create mode 100644 contact.html

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ vi contact.html

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ git commit -m "add infos"
On branch contact
Changes not staged for commit:
        modified:   contact.html

no changes added to commit

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ git add -A
warning: LF will be replaced by CRLF in contact.html.
The file will have its original line endings in your working directory

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ git commit -m "add info"
[contact e5ebc5e] add info
 1 file changed, 3 insertions(+)

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
$ git checkout master
Switched to branch 'master'

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git merge --squash contact
Updating a30e0e4..e5ebc5e
Fast-forward
Squash commit -- not updating HEAD
 contact.html | 4 ++++
 1 file changed, 4 insertions(+)
 create mode 100644 contact.html

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD <file>..." to unstage)

        new file:   contact.html


Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git commit -m "add contact page"
[master f65ed82] add contact page
 1 file changed, 4 insertions(+)
 create mode 100644 contact.html
```

3. 挑拣合并：拣选另一条分支上的某个提交条目的改动到当前分支。

   使用**git cherry-pick**命令可合并单个提交。

   切换到contact分支，修改个内容，提交到本地，记录下版本号，切换到主分支，用命令**git** **cherry-pick 38962ab** 将这一条修改同步到主分支。

   ```
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git checkout contact
   Switched to branch 'contact'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
   $ vi contact.html
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
   $ git commit -m "add a new info" -a
   [contact 38962ab] add a new info
    1 file changed, 1 insertion(+)
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (contact)
   $ git checkout master
   Switched to branch 'master'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git cherry-pick 38962ab
   [master e63b799] add a new info
    Date: Tue Nov 13 11:45:23 2018 +0800
    1 file changed, 1 insertion(+)
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git status
   On branch master
   nothing to commit, working tree clean
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git log
   commit e63b7992d6e38de9d13dc7811c594954239d402d (HEAD -> master)
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Tue Nov 13 11:45:23 2018 +0800
   
       add a new info
   
   commit f65ed82ffd6476e01efc3c36d0c60e25735aaa61
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Tue Nov 13 11:03:39 2018 +0800
   
       add contact page
   
   commit a30e0e4f827bc51bb96838f3e90444e3ac44048e (autoNew)
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Tue Nov 13 10:21:49 2018 +0800
   
       add about page
   ```

   4. git reset命令恢复前面的修改，可以看日志回到了log的倒数第二个版本。

   ```
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git log
   commit e63b7992d6e38de9d13dc7811c594954239d402d (HEAD -> master)
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Tue Nov 13 11:45:23 2018 +0800
   
       add a new info
   
   commit f65ed82ffd6476e01efc3c36d0c60e25735aaa61
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Tue Nov 13 11:03:39 2018 +0800
   
       add contact page
   
   commit a30e0e4f827bc51bb96838f3e90444e3ac44048e (autoNew)
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Tue Nov 13 10:21:49 2018 +0800
   
       add about page
   
   commit 75bfa04a676f1ae83ae8e90bcaeb43cad2452259
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Mon Nov 12 14:42:46 2018 +0800
   
       all
   
   commit 7cd72a7d61721194832f0f7dfb25b5764d4559f5
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Mon Nov 12 14:42:27 2018 +0800
   
       rename to more appreprinate name
   
   commit 665439cb7a91fa7395f771bc387ecd2b49a17c33
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Thu Nov 8 15:32:38 2018 +0800
   
       add url
   
   commit 2f4d16d7370dd81d4a5da7baad4e83a774da11bc (tag: 1.0, RB_1.0.1)
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Thu Nov 8 15:37:29 2018 +0800
   
       can push
   
   commit 041a928b39d8a8a24ddf0528320547ca961c2006
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Thu Nov 8 15:11:36 2018 +0800
   
       add head and title to index
   
       This allows for a more semantic document
   
   commit 6e71f4eb68c0b94f65bf3ff9c4fbeafec3bfe9b1
   Author: zhangjie0072 <zhangjie0072@126.com>
   Date:   Thu Nov 8 14:16:21 2018 +0800
   
       add in hello world html
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git reset --hard HEAD^
   HEAD is now at f65ed82 add contact page
   ```

   这时候再重新拣选一个版本，加参数-n，这时候可以看到，git并没有直接提交，git status查看是还有一个文件未提交。这就是加了-n参数，git等待你拣选其他的版本后一块提交的。

   ```
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git cherry-pick -n 38962ab
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git status
   On branch master
   Changes to be committed:
     (use "git reset HEAD <file>..." to unstage)
   
           modified:   contact.html
   ```

   完事儿一块 git commit -m "merge"提交就可以了。

   #### 第四节 冲突处理

   两个分支上编辑同一个文件，做不同的修改，然后合并这两条分支，一般情况下，git会成功的自动合并，但有时候也不能自动合并，不能自动合并的情况下，称之为**冲突**。冲突发生在对不同分支上的同一文件的同一文本快以不同的方式修改，并试图合并的时候。例如你可能会在不同的分支中使用不同的变量名称，而git又不能确定该使用哪个变量时，他就会停下来等待人工处理。

   ```
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
   $ git checkout -b about master
   Switched to a new branch 'about'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ vi about.html
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git add about.html
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git commit -m "add info 2"
   [about fe445de] add info 2
    1 file changed, 1 insertion(+)
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git branch about2 about
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git checkout about2
   Switched to branch 'about2'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about2)
   $ git checkout about
   Switched to branch 'about'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ vi about.html
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git commit -m "add info 3" -a
   [about 7130909] add info 3
    1 file changed, 2 insertions(+)
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git checkout about2
   Switched to branch 'about2'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about2)
   $ vi about.html
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about2)
   $ git commit -m "add info 5" -a
   [about2 5ab37bb] add info 5
    1 file changed, 1 insertion(+)
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about2)
   $ git checkout about
   Switched to branch 'about'
   
   Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about)
   $ git merge about2
   Auto-merging about.html
   CONFLICT (content): Merge conflict in about.html
   Automatic merge failed; fix conflicts and then commit the result.
   
   ```

   以上命令是先从master分支拷贝出来一个about分支，然后创建一个文件，添加一行代码，info 1，这时候用about分支创建一个about2的分支，先不切换到about2分支，此时依旧在about分支上，这时候再次修改文件，在下一行添加Info 2，并提交。这时候再切换到about2分支，同样在第二行添加info 3.然后切换到about分支，然后合并about2内容到about分支上。

   查看提示冲突的文件。<<<<后边跟随的是当前分支中的代码； 而>>>>前边跟随的是about2分支的修改。

   ```
   $ cat about.html
   I'm about.html
   info 2
   <<<<<<< HEAD
   info 3
   info 4
   =======
   info 5
   >>>>>>> about2
   ```

   对于简单的合并，手工编辑冲突即可。然后保存并正常提交。

   对于复杂的合并，可使用可视化合并工具。在命令行敲入 git mergetool命令，会启动一个合并工具。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (about|MERGING)
$ git mergetool

This message is displayed because 'merge.tool' is not configured.
See 'git mergetool --tool-help' or 'git help config' for more details.
'git mergetool' will now attempt to use one of the following tools:
opendiff kdiff3 tkdiff xxdiff meld tortoisemerge gvimdiff diffuse diffmerge ecmerge p4merge araxis bc codecompare emerge vimdiff
Merging:
about.html

Normal merge conflict for 'about.html':
  {local}: modified file
  {remote}: modified file
Hit return to start merge resolution tool (tortoisemerge):

```

敲回车，启动可视化合并工具。

手动合并后提交即可。

#### 第五节 删除分支

**git branch -d about2** 删除命令

** 只有当要删除的分支已经成功合并到当前分支时，删除分支的操作才会成功。

这时候我们切换到主分支，about2的分支没有合并到master。如下。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch -d about2
error: The branch 'about2' is not fully merged.
If you are sure you want to delete it, run 'git branch -D about2'.
```

删除不了，想删除的话，参数 换成-D。

#### 第六节 分支重命名

**git branch -m contact comtacts** 

-m 不会覆盖已有分支名称，所以新分支名称必须是唯一的。否则就会报错。如果想覆盖已有分支名称，改成-M。强制覆盖现有分支。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch
  RB_1.0.1
  about
  about2
  autoNew
  contact
* master

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch -m contact contacts

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch
  RB_1.0.1
  about
  about2
  autoNew
  contacts
* master

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch -m about2 contacts
fatal: A branch named 'contacts' already exists.
```

-M强制覆盖，就没了。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch
  RB_1.0.1
  about
  about2
  autoNew
  contacts
* master

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch -M about2 contacts

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch
  RB_1.0.1
  about
  autoNew
  contacts
* master
```

查看分支查看的是包括所有主分支上的日志。同步前的所有日志。直接创建分支是从当前分支内容创建新分支。

```
Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch -M new01 new02

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git branch
  RB_1.0.1
  about
  autoNew
  contacts
* master
  new02

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (master)
$ git checkout new02
Switched to branch 'new02'

Orange@DESKTOP-8VK4FUU MINGW64 /d/MyGit/mysite (new02)
$ git log
commit 9f6b0246c3c2fd1930c78bd821a8875873548c53 (HEAD -> new02)
Author: zhangjie0072 <zhangjie0072@126.com>
Date:   Tue Nov 13 15:50:06 2018 +0800

    add new01.txt

commit 89f9869907d3f986e601e0339e7427510580cfd9 (about)
Merge: 7130909 5ab37bb
Author: zhangjie0072 <zhangjie0072@126.com>
Date:   Tue Nov 13 15:29:25 2018 +0800

    after merge

commit 5ab37bb6eba8aa1c4f9691fc2829a9d774748ad6 (contacts)
Author: zhangjie0072 <zhangjie0072@126.com>
Date:   Tue Nov 13 15:09:32 2018 +0800

    add info 5
```

第五章完 2018.11.13